<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Session UI</title>
    <style>
        body { font-family: Arial; display: flex; gap: 20px; padding: 20px; }
        #sessions { width: 200px; }
        #chat { flex: 1; display: flex; flex-direction: column; }
        textarea { width: 100%; height: 100px; }
        .session-item { cursor: pointer; border: 1px solid #ccc; padding: 5px; margin: 2px 0; }
        .message { margin: 5px 0; }
        .user { color: blue; }
        .assistant { color: green; }
        .loading { color: gray; font-style: italic; }
        #chatHistory { border:1px solid #ccc; padding:10px; height:300px; overflow:auto; background: #f9f9f9; }
        
        .session-item.selected {
            background-color: #d0ebff;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div id="sessions">
        <h3>Sessions</h3>
        <button onclick="loadSessions()">ğŸ” Refresh</button>
        <ul id="sessionList"></ul>
        <input id="newTitle" placeholder="New Session Title" />
        <button onclick="createSession()">â• Create</button>
    </div>

    <div id="chat">
        <h3 id="sessionTitle">No session selected</h3>
        <div>
            <input id="editTitle" placeholder="Edit title..." />
            <button onclick="updateTitle()">âœï¸ Update Title</button>
            <button onclick="deleteSession()">ğŸ—‘ï¸ Delete</button>
        </div>

        <div id="chatHistory"></div>
        <textarea id="userMessage" placeholder="Type your message..."></textarea>
        <button onclick="sendMessage()">ğŸ“¤ Send</button>
    </div>

    <script>
        let currentSelectedSessionId = null;

        async function loadSessions() {
            const res = await fetch("/sessions");
            const sessions = await res.json();
            const list = document.getElementById("sessionList");
            list.innerHTML = "";
            sessions.forEach(sess => {
                const li = document.createElement("li");
                li.className = "session-item";
                li.textContent = sess.title;
                li.onclick = () => selectSession(sess.id, sess.title, li);
                list.appendChild(li);
            });
        }

        async function selectSession(id, title, liElement) {
            const chatDiv = document.getElementById("chatHistory");
            const sessionTitleElem = document.getElementById("sessionTitle");
            const editTitleInput = document.getElementById("editTitle");

            // å¦‚æœé»åˆ°çš„æ˜¯ç›®å‰é¸å–çš„ sessionï¼Œå–æ¶ˆé¸å– â†’ è®Šæˆè‡¨æ™‚å°è©±
            if (currentSelectedSessionId === id) {
                currentSelectedSessionId = null;
                sessionTitleElem.textContent = "è‡¨æ™‚å°è©±";
                editTitleInput.value = "";
                chatDiv.innerHTML = "";
                
                // ç§»é™¤æ‰€æœ‰ li çš„ .selected æ¨£å¼
                document.querySelectorAll(".session-item").forEach(li => {
                    li.classList.remove("selected");
                });

                return;
            }

            // æ›´æ–°ç›®å‰é¸æ“‡çš„ session
            currentSelectedSessionId = id;
            sessionTitleElem.textContent = title;
            editTitleInput.value = title;

            // æ¸…é™¤èˆŠçš„ .selected æ¨£å¼
            document.querySelectorAll(".session-item").forEach(li => {
                li.classList.remove("selected");
            });

            // åŠ ä¸Šç›®å‰ li çš„ .selected æ¨£å¼
            liElement.classList.add("selected");

            // è¼‰å…¥æ­·å²è¨Šæ¯
            try {
                const res = await fetch(`/messages?session_id=${id}`);
                const messages = await res.json();

                chatDiv.innerHTML = "";
                messages.forEach(msg => appendMessage(msg.role, msg.content));
            } catch (error) {
                console.error("è®€å–æ­·å²è¨Šæ¯éŒ¯èª¤ï¼š", error);
                chatDiv.innerHTML = "<p>âš ï¸ ç„¡æ³•è¼‰å…¥æ­·å²è¨Šæ¯</p>";
            }
        }

        function appendMessage(role, content) {
            const chatDiv = document.getElementById("chatHistory");
            const div = document.createElement("div");

            if (role === "user") {
                div.className = "user-msg";
                div.textContent = `User: ${content}`;
            } else if (role === "assistant") {
                div.className = "assistant-msg";
                div.textContent = `Assistant: ${content}`;
            } else if (role === "loading") {
                div.className = "loading-msg";
                div.innerHTML = `<span id="${content.id}">ğŸ¤– ${content.text}</span>`;
            }

            chatDiv.appendChild(div);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        async function createSession() {
            const title = document.getElementById("newTitle").value.trim();
            if (!title) return alert("Title required!");

            try {
                const res = await fetch("/sessions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ title })
                });

                if (res.status === 422) {
                    const error = await res.json();
                    const detail = error.detail?.[0]?.msg || "Invalid input";
                    alert(`âŒ Validation Error:\n${detail}`);
                    return;
                }

                if (!res.ok) {
                    const text = await res.text();
                    alert(`âŒ Server Error ${res.status}:\n${text}`);
                    return;
                }

                document.getElementById("newTitle").value = "";
                loadSessions();
            } catch (err) {
                console.error("Unexpected error:", err);
                alert("âŒ Unexpected error occurred.");
            }
        }

        async function deleteSession() {
            if (!currentSelectedSessionId) return alert("Select a session first!");
            await fetch(`/sessions/${currentSelectedSessionId}`, { method: "DELETE" });
            currentSelectedSessionId = null;
            loadSessions();
            document.getElementById("chatHistory").innerHTML = "";
            document.getElementById("sessionTitle").textContent = "No session selected";
        }

        async function updateTitle() {
            const newTitle = document.getElementById("editTitle").value.trim();
            if (!currentSelectedSessionId || !newTitle) return;

            const res = await fetch(`/sessions/${currentSelectedSessionId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: newTitle })
            });

            if (res.status === 422) {
                const error = await res.json();
                const detail = error.detail?.[0]?.msg || "Invalid input";
                alert(`âŒ Validation Error:\n${detail}`);
                return;
            }

            if (!res.ok) {
                alert(`âŒ Server Error ${res.status}`);
                return;
            }

            loadSessions();
        }

        async function sendMessage() {
            const msg = document.getElementById("userMessage").value.trim();
            if (!msg) return;

            const isTempMode = !currentSelectedSessionId;
            appendMessage("user", msg);
            document.getElementById("userMessage").value = "";

            const endpoint = isTempMode
                ? "/chat"
                : `/chat?session_id=${currentSelectedSessionId}`;

            const payload = {
                model: "phi3",
                stream: false,
                messages: [{ role: "user", content: msg }]
            };

            // ğŸ”½ åŠ å…¥ã€Œè¼‰å…¥ä¸­ã€è¨Šæ¯æç¤º
            const loadingId = `loading-${Date.now()}`;
            appendMessage("loading", { id: loadingId, text: "Assistant is thinking..." });

            try {
                const res = await fetch(endpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                const assistantMsg = result?.message?.content || result?.choices?.[0]?.message?.content || "(No response)";

                // ğŸ”½ ç”¨å¯¦éš›å›æ‡‰å…§å®¹æ›¿æ›ã€Œè¼‰å…¥ä¸­ã€æç¤º
                const loadingElem = document.getElementById(loadingId);
                if (loadingElem) {
                    loadingElem.textContent = `Assistant: ${assistantMsg}`;
                    loadingElem.className = "assistant-msg";
                }

            } catch (error) {
                console.error("ç™¼é€å¤±æ•—", error);
                const loadingElem = document.getElementById(loadingId);
                if (loadingElem) {
                    loadingElem.textContent = "âš ï¸ éŒ¯èª¤ï¼šç„¡æ³•å–å¾—å›æ‡‰ã€‚";
                    loadingElem.className = "assistant-msg";
                }
            }
        }

        loadSessions();
    </script>
</body>
</html>
